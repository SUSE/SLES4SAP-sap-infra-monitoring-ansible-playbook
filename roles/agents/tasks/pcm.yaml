---

- name: Firewall permit traffic for pcm port
  ansible.posix.firewalld:
    port: "{{pcm_port}}/tcp"
    permanent: true
    state: enabled
    immediate: true
  when:
    - "'firewalld' in ansible_facts.packages"
    - ansible_facts.services["firewalld.service"].state == "running"

- name: Install pcm
  community.general.zypper:
    name: pcm
    state: latest

- name: Create pcm sysconfig file
  ansible.builtin.template:
    src: sysconfig-pcm
    dest: /etc/sysconfig/pcm-sensor-server
    mode: "0644"
  register: pcm_sysconfig_conf

- name: Create pcm systemd service file
  ansible.builtin.template:
    src: pcm_systemd_service
    dest: /etc/systemd/system/pcm.service
    mode: "0644"
  register: pcm_systemd_service_conf 

- name: Restart pcm
  ansible.builtin.service:
    name: pcm.service
    enabled: true
    state: restarted
  when:
    - pcm_sysconfig_conf.changed or 
      ansible_facts.services["prometheus-node_exporter.service"].state != "running" 