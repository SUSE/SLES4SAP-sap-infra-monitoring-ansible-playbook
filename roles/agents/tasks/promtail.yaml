---

# Deploy Promtail
- block: 
    
  - name: Firewall permit traffic for Promtail ports
    ansible.posix.firewalld:
      port: "{{promtail_port}}/tcp"
      permanent: true
      state: enabled
      immediate: true
    when:
      - "'firewalld' in ansible_facts.packages"
      - ansible_facts.services["firewalld.service"].state == "running"

  - name: Install promtail
    community.general.zypper:
      name: promtail
      state: latest

  - name: Create /etc/loki/promtail.yaml
    ansible.builtin.template:
      src: promtail.yaml
      dest: /etc/loki/promtail.yaml
      mode: "0644"
    register: promtail_conf  

  - name: Restart promtail
    ansible.builtin.service:
      name: promtail.service
      enabled: true
      state: restarted
    when:
      - promtail_conf.changed or
        ansible_facts.services["promtail.service"].state != "running"  

  when: deploy_loki_server and (groups['loki_server'] | length  == 1) and deploy_promtail



# Don't deploy promtail, stop service and disable port 
- block:

  - name: Stop Promtail
    ansible.builtin.service:
      name: promtail.service
      enabled: false
      state: stopped
      
  # Please note that "immediate:" is not set to disable the firewall rule.
  # This is needed to disable the port also on a stopped firewalld.
  - name: Firewall disable collectd port
    ansible.posix.firewalld:
      port: "{{promtail_port}}/tcp"
      permanent: true
      offline: true
      state: disabled
    when:
      - "'firewalld' in ansible_facts.packages"

  when: not deploy_loki_server or (groups['loki_server'] | length  == 0) or not deploy_promtail
  

